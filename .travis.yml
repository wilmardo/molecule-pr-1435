---
dist: trusty
language: python
python:
  - "3.6"
sudo: required
cache:
  pip: true

env:
  global:
    - fast_finish: true

services:
  - docker

addons:
  apt:
    sources:
      - docker-trusty
    packages:
      - docker-ce

before_install:
  - sudo apt-get update && sudo apt-get remove -y lxd

install:
  - sudo apt-get -qq update;
  - sudo apt-get -y install snapd python3.5;
  - sudo snap install lxd;
  - sudo sh -c 'echo PATH=/snap/bin:$PATH >> /etc/environment';
  - while [ ! -S /var/snap/lxd/common/lxd/unix.socket ]; do echo "Waiting for LXD socket...";sleep 0.2;done;
  - sudo bash -c "$(wget -qO - https://raw.githubusercontent.com/LANsible/ansible-dev-container/lxd/setup-lxd.sh)"

script:
  - docker run --net=host -it -v $(pwd):/data/$(basename ~+) -w /data/$(basename ~+) lansible/ansible-dev-container:test lxc remote list
  - docker run --net=host -it -v $(pwd):/data/$(basename ~+) -w /data/$(basename ~+) lansible/ansible-dev-container:test lxc launch ubuntu:16.04
  - docker run --net=host -it -v $(pwd):/data/$(basename ~+) -w /data/$(basename ~+) lansible/ansible-dev-container:test molecule --debug converge

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
  email:
    on_failure: change
  on_success: never
